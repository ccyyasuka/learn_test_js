<!DOCTYPE html>
<html lang="zh-cmn-Hans">
	<head>
		<meta charset="utf-8" />
		<meta http-equiv="x-ua-compatible" content="IE=edge, chrome=1" />
		<style></style>
	</head>

	<body>
		<script>

      const applyMiddleware = function (...middlewares) {
        /*è¿”å›ä¸€ä¸ªé‡å†™createStoreçš„æ–¹æ³•*/
        return function rewriteCreateStoreFunc(oldCreateStore) {
          /*è¿”å›é‡å†™åæ–°çš„ createStore*/
          return function newCreateStore(reducer, initState) {
            /*1. ç”Ÿæˆstore*/
            const store = oldCreateStore(reducer, initState);
            /*ç»™æ¯ä¸ª middleware ä¼ ä¸‹storeï¼Œç›¸å½“äº const logger = loggerMiddleware(store);*/
            /* const chain = [exception, time, logger]*/
            const chain = middlewares.map(middleware => middleware(store));
            let dispatch = store.dispatch;
            /* å®ç° exception(time((logger(dispatch))))*/
            chain.reverse().map(middleware => {
              dispatch = middleware(dispatch);
            });

            /*2. é‡å†™ dispatch*/
            store.dispatch = dispatch;
            return store;
          }
        }
      }


      // reducerå°±æ˜¯è®¡åˆ’ï¼Œæ¥å—è€çš„stateå’Œè¦æ‰§è¡Œçš„åŠ¨ä½œï¼Œè¿”å›æ–°çš„state
      // ä¸‹é¢ä¸¤ä¸ªreduceråˆ†åˆ«ç®¡ç†counterå’Œinfoçš„çŠ¶æ€ï¼Œåœ¨combine reduceråˆå¹¶
      // let initState = {
      //   counter:{
      //     count:0,
      //   },
      //   info: {
      //     name: 'aaa',
      //     description: 'æ—§ä»‹ç»'
      //   }
      // }
      let counterState={
        count:0
      }
      function counterReducer(state, action) {
        if(state===undefined){
         state=counterState
        }
        // æ­¤å¤„çš„stateæ˜¯iniState.counter
        switch (action.type) {
          case 'INCREMENT':
            return {
              count:state.count+1
            }
          case 'DECREMENT':
            return {
              count:state.count-1
            }
          default:
            return state;
        }
      }
      let infoState={
          name: 'aaa',
          description: 'æ—§ä»‹ç»'
        }
      function infoReducer(state, action) {
        if(state===undefined){
          state=infoState
        }
        // å˜åŒ–ä¿¡æ¯æ˜¯åœ¨actionä¸­ä¼ çš„
        switch (action.type) {
          case 'setName':
            return {
              ...state,
              name: action.name
            }
          case 'setDesc':
            return {
              ...state,
              description: action.description
            }
          default:
            return state;
        }
      }
      function combineReducer(reducers){
        const reducerKeys=Object.keys(reducers)
        console.log(reducerKeys)
        // combineReducerä¼šè¿”å›ä¸€ä¸ªæ–°çš„reducerå‡½æ•°ï¼Œæ¥æ”¶æ€»çš„stateå’Œaction,è¿”å›æ–°çš„æ€»çš„state
        const res=function(state={},action){
          // å¾…ç”Ÿæˆçš„æ–°state
          const nextState={}
          for(let i=0;i<reducerKeys.length;i++){
            const curKey=reducerKeys[i]
            const curReducer=reducers[curKey]
            const curState=state[curKey]
            const newState=curReducer(curState,action)
            nextState[curKey]=newState
          }
          // console.log(reducerKeys)
          return nextState
        }
        return res
      }
			// class createStore{
      //   constructor(reducer,iniState){
      //     // debugger
      //     this.state=iniState
      //     this.listeners=[]
      //     this.reducer=reducer
      //     this.dispatch({type:Symbol()})
      //   }
      //   // æ³¨å†Œstateå‘ç”Ÿå˜åŒ–æ—¶è‡ªåŠ¨è§¦å‘çš„äº‹ä»¶
      //   subscribe(func) {
      //     this.listeners.push(func)
      //   }
      //   // æ¥æ”¶å˜åŒ–ï¼Œè¿›è¡ŒçŠ¶æ€æ”¹å˜å’Œäº‹ä»¶è§¦å‘
      //   dispatch(action){
      //     debugger
      //     this.state = this.reducer(this.state, action)
      //     this.listeners.forEach(
      //       (listener) => {
      //         listener()
      //       }
      //     )
      //   }
      //   getState(){
      //     return this.state
      //   }
      // }
      function createStore(reducer, initState, rewriteCreateStoreFunc) {
        /*å¦‚æœæœ‰ rewriteCreateStoreFuncï¼Œé‚£å°±é‡‡ç”¨æ–°çš„ createStore */
        if(rewriteCreateStoreFunc){
          const newCreateStore =  rewriteCreateStoreFunc(createStore);
          return newCreateStore(reducer, initState);
        }
        let state = initState;
        let listeners = [];

        function subscribe(listener) {
          listeners.push(listener);
        }

        function dispatch(action) {
          state = reducer(state, action);
          for (let i = 0; i < listeners.length; i++) {
            const listener = listeners[i];
            listener();
          }
        }

        function getState() {
          return state;
        }

        dispatch({ type: Symbol() });

        return {
          subscribe,
          dispatch,
          getState
        }
      }




      // ä¸­é—´ä»¶éœ€æ±‚ï¼šåœ¨æ”¹å˜çŠ¶æ€æ—¶è®°å½•ä¸€ä¸‹
      // å•ä¸ªä¸­é—´ä»¶å¤„ç†é€»è¾‘å¦‚ä¸‹ï¼Œæœ¬è´¨å°±æ˜¯æ”¹å†™dispatchå‡½æ•°
      // const next = store.dispatch;
      // store.dispatch=(action)=>{
      //   console.log("ini State",store.getState())
      //   console.log("action",action)
      //   next(action)
      //   console.log("new State",store.getState())
      // }
      // æœ‰è‹¥å¹²ä¸ªä¸­é—´ä»¶è¯¥æ€ä¹ˆåŠï¼Œä¸æ–­æ‰©å®¹dispatchå‡½æ•°å¤ªä¸ä¼˜é›…äº†
      //  è®¾å®šæ—¥å¿—ä¸­é—´ä»¶
      const loggerMiddleware = (store)=> (next)=>(action) => {
        console.log('this state', store.getState());
        console.log('action', action);
        next(action);
        console.log('next state', store.getState());
      }
      // è®¾å®šè®°å½•å¼‚å¸¸ä¸­é—´ä»¶ï¼Œä¸ºäº†é¿å…å†™æ­»loggerMiddlewareï¼Œè®©loggerMiddlewareä¹Ÿå˜æˆå‚æ•°ä¼ è¿›æ¥
      // const exceptionMiddleware = (action) => {
      //   try {
      //     /*next(action)*/
      //     loggerMiddleware(action);
      //   } catch (err) {
      //     console.error('é”™è¯¯æŠ¥å‘Š: ', err)
      //   }
      // }
      const exceptionMiddleware = (store)=> (next) => (action) => {
        try {
          /*loggerMiddleware(action);*/
          next(action);
        } catch (err) {
          console.error('é”™è¯¯æŠ¥å‘Š: ', err)
        }
      }
      const timeMiddleware = (store) => (next) => (action) => {
        console.log('time', new Date().getTime());
        next(action);
      }




      // reducerçš„keyåº”è¯¥å’Œstateçš„keyä¿æŒä¸€è‡´
      const reducer=combineReducer({counter:counterReducer,info:infoReducer})
      // const store=new createStore(reducer, initState)
      /**
       * æ³¨æ„ï¼šæˆ‘ä»¬æ²¡æœ‰ä¼  initState è¿›å»ï¼Œå› ä¸ºåˆå§‹åŒ–çš„æ—¶å€™ä¼šæ‰§è¡Œ dispatch({ type: Symbol() });;
       * è§¦å‘ state = reducer(state, action)
       * å› ä¸º state ä¸º undefinedï¼Œaction.type ä¸ºä¸åŒ¹é…ä»»ä½•è®¡åˆ’ä¸­ type çš„å€¼ï¼Œæ‰€ä»¥ä¼šè¿”å› reducer ä¸­è®¾ç½®çš„é»˜è®¤å€¼ï¼Œå®Œæˆåˆå§‹åŒ–
      * */

      const rewriteCreateStoreFunc = applyMiddleware(exceptionMiddleware, timeMiddleware, loggerMiddleware);
      const store = createStore(reducer, undefined, rewriteCreateStoreFunc);
      store.subscribe(()=>{
        const state=store.getState()
        console.log("æ¥æ”¶åˆ°äº†æ–°çŠ¶æ€",state.counter.count,state.info.name,state.info.description)
      })


      // ğŸ‘‡ä¸‹é¢æ˜¯å¤æ‚ç”¨æ³•
      // const next = store.dispatch;
      // const logger = loggerMiddleware(store);
      // const exception = exceptionMiddleware(store);
      // const timeLogger=timeMiddleware(store)
      // store.dispatch = exception(timeLogger(logger(next)));

      // ç”¨æˆ·åªçœ‹åˆ°ä¸‰ä¸ªä¸­é—´ä»¶å°±å¤Ÿäº†ï¼ŒğŸ‘†è¿™äº›è¡Œä¸ºéƒ½å¯ä»¥å°è£…èµ·æ¥



      // actionçš„ç»“æ„æ˜¯{type:"è¡ŒåŠ¨ç±»å‹", å…¶ä½™ä¿¡æ¯}
      store.dispatch({
        type:'INCREMENT',
      })
      store.dispatch({
        type:'INCREMENT',
      })
      store.dispatch({
        type:'setName',
        name:'æ–°åå­—111'
      })
      store.dispatch({
        type:'setName',
        des:'æ–°åå­—111'
      })
      store.dispatch({
        type:'setDesc',
        description:'æ–°ä»‹ç»111'
      })
		</script>
	</body>
</html>
